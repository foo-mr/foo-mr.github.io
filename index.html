<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¬¦è€å¸ˆå·¥å…·ç®± (Pro Edition)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.0/dist/confetti.browser.js"></script>
    <!-- å¼•å…¥ html2canvas ç”¨äºæˆªå›¾ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            --bg-color: #0f172a;
            --panel-color: #1e293b;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --color-success: #10b981;
            --color-warning: #f59e0b;
            --color-danger: #ef4444;
            --color-accent: #3b82f6;
            --font-stack: 'Inter', 'Noto Sans SC', system-ui, -apple-system, sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
        }

        * { box-sizing: border-box; }
        body {
            font-family: var(--font-stack);
            background-color: var(--bg-color);
            color: var(--text-main);
            height: 100vh; width: 100vw; overflow: hidden; display: flex;
            line-height: 1.5;
        }

        /* --- Sidebar --- */
        #sidebar {
            width: 280px; flex-shrink: 0; background-color: var(--panel-color);
            padding: 1.5rem; border-right: 1px solid #334155; transition: margin-left 0.3s ease;
            display: flex; flex-direction: column; overflow-y: auto;
        }
        body.sidebar-retracted #sidebar { margin-left: -280px; }
        .brand-title { font-size: 1.5rem; font-weight: 800; text-align: center; margin-bottom: 0.5rem; color: var(--color-warning); letter-spacing: -0.025em; }
        .brand-subtitle { font-size: 0.65rem; font-weight: 700; text-align: center; margin-bottom: 2rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.1em; opacity: 0.7; }
        
        .nav-btn {
            display: flex; align-items: center; width: 100%; text-align: left; padding: 0.8rem 1rem;
            border-radius: 0.75rem; color: var(--text-muted); font-weight: 600; transition: all 0.2s;
            margin-bottom: 0.5rem; gap: 0.75rem;
        }
        .nav-btn:hover { background-color: #334155; color: white; }
        .nav-btn.active { background-color: var(--color-accent); color: white; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }

        #content-area { flex-grow: 1; padding: 2.5rem; overflow-y: auto; position: relative; display: flex; flex-direction: column; }
        .app-content { display: none; max-width: 1000px; margin: 0 auto; width: 100%; animation: fadeIn 0.3s ease; flex-grow: 1; }
        .app-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- UI Components --- */
        .app-card { background-color: var(--panel-color); border-radius: 1.25rem; padding: 2rem; border: 1px solid #334155; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.3); }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-muted); font-size: 0.875rem; }
        .form-input {
            width: 100%; padding: 0.75rem 1rem; background-color: #0f172a; border: 1px solid #475569;
            border-radius: 0.75rem; color: white; font-size: 1rem; transition: all 0.2s;
            font-family: var(--font-stack);
        }
        .form-input:disabled { opacity: 0.5; cursor: not-allowed; background-color: #1e293b; }
        .form-input:focus { outline: none; border-color: var(--color-accent); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
        
        /* Time Input Icon Fix */
        input[type="time"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
            opacity: 0.8;
        }

        /* --- Tags Management --- */
        .tag-container { 
            min-height: 120px; max-height: 280px; overflow-y: auto; 
            display: flex; flex-wrap: wrap; align-content: flex-start; gap: 0.6rem; 
            padding: 1.25rem; border: 2px dashed #334155; border-radius: 0.75rem; 
            background: rgba(15, 23, 42, 0.4);
        }
        /* Class Manager Styles */
        .class-manager-bar {
            display: flex; gap: 0.5rem; margin-bottom: 1rem; padding: 0.75rem;
            background: rgba(30, 41, 59, 0.5); border-radius: 0.75rem; border: 1px solid #334155;
            align-items: center;
            flex-wrap: wrap;
        }
        .class-select {
            flex-grow: 1; background: #0f172a; border: 1px solid #475569; color: white;
            padding: 0.5rem; border-radius: 0.5rem; font-size: 0.9rem; min-width: 150px;
        }
        .class-btn {
            padding: 0.5rem 0.8rem; font-size: 0.85rem; font-weight: 600; border-radius: 0.5rem;
            cursor: pointer; transition: all 0.2s; white-space: nowrap; display: flex; align-items: center; gap: 4px;
        }
        .class-btn-save { background: #0f766e; color: #ccfbf1; }
        .class-btn-save:hover { background: #115e59; }
        .class-btn-link { background: #4f46e5; color: #e0e7ff; }
        .class-btn-link:hover { background: #4338ca; }
        .class-btn-del { background: #991b1b; color: #fee2e2; }
        .class-btn-del:hover { background: #7f1d1d; }

        .tag {
            display: inline-flex; align-items: center; padding: 0.45rem 0.9rem; 
            border-radius: 0.6rem; font-size: 0.95rem; font-weight: 700; color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1);
            animation: tagPop 0.2s ease-out;
        }
        @keyframes tagPop { from { transform: scale(0.85); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .tag:nth-child(4n+1) { background-color: #3b82f6; }
        .tag:nth-child(4n+2) { background-color: #8b5cf6; }
        .tag:nth-child(4n+3) { background-color: #10b981; }
        .tag:nth-child(4n+4) { background-color: #6366f1; }
        
        .tag .remove { margin-left: 0.6rem; cursor: pointer; opacity: 0.6; font-size: 1.1rem; transition: opacity 0.2s; }
        .tag .remove:hover { opacity: 1; }

        .btn { padding: 0.75rem 1.5rem; border-radius: 0.75rem; font-weight: 700; transition: all 0.2s; cursor: pointer; border: none; display: inline-flex; align-items: center; justify-content: center; font-family: var(--font-stack); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: var(--color-accent); color: white; }
        .btn-primary:hover:not(:disabled) { transform: translateY(-1px); filter: brightness(1.1); }
        .btn-warning { background: var(--color-warning); color: #000; }
        .btn-warning:hover:not(:disabled) { transform: translateY(-1px); filter: brightness(1.1); }

        /* --- Clock & Timer --- */
        .big-timer { font-size: 7.5rem; font-weight: 800; font-family: var(--font-mono); color: white; letter-spacing: -2px; line-height: 1; }
        .big-timer.critical { color: var(--color-danger); animation: pulse 1s infinite; }
        .big-timer.waiting { color: var(--color-warning); font-size: 5rem; } 
        @keyframes pulse { 50% { opacity: 0.5; } }

        .clock-face { fill: #1e293b; stroke: #334155; stroke-width: 6; }
        .tick-major { stroke: #f8fafc; stroke-width: 3; }
        .tick-minor { stroke: #475569; stroke-width: 1.5; }
        .clock-num { fill: #94a3b8; font-size: 14px; font-weight: 700; font-family: var(--font-stack); }
        .h-hour { stroke: #ffffff; stroke-width: 6; stroke-linecap: round; }
        .h-min { stroke: #cbd5e1; stroke-width: 4; stroke-linecap: round; }
        .h-sec { stroke: var(--color-danger); stroke-width: 2; stroke-linecap: round; }
        .h-cap { fill: var(--color-danger); }

        #sidebar-toggle { position: absolute; top: 1.5rem; left: 1rem; z-index: 100; color: white; background: var(--panel-color); width: 40px; height: 40px; border-radius: 50%; border: 1px solid #334155; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.2); }

        .mode-selector { display: flex; background: #0f172a; padding: 4px; border-radius: 0.75rem; margin-bottom: 1.5rem; border: 1px solid #334155; }
        .mode-btn { flex: 1; padding: 0.6rem; text-align: center; border-radius: 0.6rem; cursor: pointer; font-weight: 700; font-size: 0.9rem; transition: all 0.2s; color: var(--text-muted); }
        .mode-btn.active { background: #334155; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

        /* Winner Card Animation */
        .chosen-card { animation: winnerGlow 1.5s infinite alternate; }
        @keyframes winnerGlow { from { box-shadow: 0 0 20px rgba(59, 130, 246, 0.5); } to { box-shadow: 0 0 40px rgba(59, 130, 246, 0.8), 0 0 60px rgba(59, 130, 246, 0.4); } }

        /* --- Grouping Results Styles --- */
        .name-reveal { opacity: 0; transform: translateY(10px); transition: all 0.5s ease; }
        .name-reveal.visible { opacity: 1; transform: translateY(0); }
        
        .group-card-colors { --color-bg: #e0e7ff; --color-text: #3730a3; --color-header-bg: #4f46e5; --color-header-text: #ffffff; }
        .group-color-1 { --color-bg: #dbeafe; --color-text: #1e40af; --color-header-bg: #2563eb; }
        .group-color-2 { --color-bg: #d1fae5; --color-text: #065f46; --color-header-bg: #10b981; }
        .group-color-3 { --color-bg: #fef3c7; --color-text: #92400e; --color-header-bg: #f59e0b; }
        .group-color-4 { --color-bg: #fee2e2; --color-text: #991b1b; --color-header-bg: #ef4444; }
        .group-color-5 { --color-bg: #f3e8ff; --color-text: #581c87; --color-header-bg: #9333ea; }
        .group-color-6 { --color-bg: #ffe4e6; --color-text: #9f1239; --color-header-bg: #e11d48; }
        .group-color-7 { --color-bg: #e0f2fe; --color-text: #075985; --color-header-bg: #0ea5e9; }
        .group-color-8 { --color-bg: #dcfce7; --color-text: #166534; --color-header-bg: #22c55e; }

        /* Toast Notification */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: #334155; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); border-left: 4px solid #3b82f6; animation: slideIn 0.3s ease-out; font-weight: 500; display: flex; align-items: center; justify-content: space-between; min-width: 250px; }
        .toast.success { border-left-color: #10b981; }
        .toast.error { border-left-color: #ef4444; }
        .toast.info { border-left-color: #3b82f6; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body>

    <button id="sidebar-toggle">â˜°</button>

    <!-- Sidebar -->
    <div id="sidebar">
        <div>
            <h1 class="brand-title">ç¬¦è€å¸ˆå·¥å…·ç®±</h1>
            <p class="brand-subtitle">Created by ç¬¦è€å¸ˆ</p>
        </div>
        <nav>
            <button id="nav-lucky-draw" class="nav-btn active"><span>âœ¨</span> å¹¸è¿æŠ½å¥–</button>
            <button id="nav-grouping" class="nav-btn"><span>ğŸ‰</span> éšæœºåˆ†ç»„</button>
            <button id="nav-exam-timer" class="nav-btn"><span>â±ï¸</span> è€ƒè¯•å€’æ•°</button>
            <button id="nav-data-mgmt" class="nav-btn text-blue-300 hover:text-blue-100"><span>ğŸ’¾</span> å¤‡ä»½ä¸æ¢å¤</button>
        </nav>
        
        <div class="mt-auto pt-6 border-t border-slate-700 text-center pb-4">
            <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mb-1">Developed By</p>
            <p class="text-sm text-slate-300 font-black">ç¬¦è€å¸ˆ</p>
        </div>
    </div>

    <div id="content-area">
        <!-- App: Data Mgmt -->
        <div id="app-data-mgmt" class="app-content">
            <div class="app-card max-w-lg mx-auto">
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-extrabold text-white mb-2">ğŸ’¾ æ•°æ®å¤‡ä»½ä¸æ¢å¤</h2>
                    <p class="text-muted">é€‚ç”¨äº GitHub Pages / ç¦»çº¿ç¯å¢ƒ</p>
                </div>

                <div class="bg-slate-800/50 p-6 rounded-xl border border-slate-700 space-y-6">
                    <div class="text-sm text-slate-400">
                        <p class="mb-2 font-bold text-blue-400">â“ å¦‚ä½•è·¨ç”µè„‘ä½¿ç”¨ï¼Ÿ</p>
                        <ul class="list-disc pl-5 space-y-1">
                            <li><b>æ–¹å¼ A (æ–‡ä»¶):</b> åœ¨å­¦æ ¡ç”µè„‘ã€å¯¼å‡ºå¤‡ä»½æ–‡ä»¶ã€‘ï¼Œå‘é€åˆ°å®¶ä¸­ç”µè„‘ï¼Œç„¶åã€å¯¼å…¥å¤‡ä»½æ–‡ä»¶ã€‘ã€‚</li>
                            <li><b>æ–¹å¼ B (é“¾æ¥):</b> åœ¨ã€å¹¸è¿æŠ½å¥–ã€‘æˆ–ã€éšæœºåˆ†ç»„ã€‘é¡µé¢ï¼Œé€‰ä¸­ç­çº§åç‚¹å‡»ã€ğŸ”— åˆ†äº«ã€‘æŒ‰é’®ç”Ÿæˆé“¾æ¥ã€‚</li>
                        </ul>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <button id="btn-file-export" class="btn bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 flex flex-col items-center gap-1 shadow-lg group">
                            <span class="text-2xl group-hover:-translate-y-1 transition-transform">ğŸ“¤</span>
                            <span>å¯¼å‡ºæ‰€æœ‰æ•°æ® (JSON)</span>
                        </button>
                        
                        <div class="relative w-full">
                            <input type="file" id="file-import-input" accept=".json" class="hidden">
                            <button id="btn-file-import" class="btn bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-4 flex flex-col items-center gap-1 shadow-lg w-full group">
                                <span class="text-2xl group-hover:translate-y-1 transition-transform">ğŸ“¥</span>
                                <span>å¯¼å…¥æ•°æ®æ–‡ä»¶</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- App: Lucky Draw -->
        <div id="app-lucky-draw" class="app-content active">
            <div id="ld-home-view" class="app-card">
                <div class="text-center mb-6">
                    <h2 class="text-3xl font-extrabold text-white mb-2">âœ¨ å¹¸è¿æŠ½å¥–</h2>
                    <p class="text-muted">ç²˜è´´åå•æˆ–ç›´æ¥è¾“å…¥å§“åï¼ˆå›è½¦æˆ–ç²˜è´´å³è‡ªåŠ¨ç”Ÿæˆæ ‡ç­¾ï¼‰</p>
                </div>
                
                <!-- Class Manager UI -->
                <div class="class-manager-bar">
                    <span class="text-xs font-bold text-slate-400 uppercase tracking-wider hidden sm:inline">ç­çº§:</span>
                    <select id="ld-class-select" class="class-select">
                        <option value="">-- é€‰æ‹©ç­çº§ --</option>
                    </select>
                    <button id="ld-save-class-btn" class="class-btn class-btn-save" title="ä¿å­˜å½“å‰åå•">ğŸ’¾ <span class="hidden sm:inline">ä¿å­˜</span></button>
                    <button id="ld-share-class-btn" class="class-btn class-btn-link" title="ç”Ÿæˆåˆ†äº«é“¾æ¥">ğŸ”— <span class="hidden sm:inline">åˆ†äº«</span></button>
                    <button id="ld-del-class-btn" class="class-btn class-btn-del" title="åˆ é™¤ç­çº§">ğŸ—‘ï¸</button>
                </div>

                <div id="ld-tag-container" class="tag-container mb-4"></div>
                <input type="text" id="ld-name-input" class="form-input mb-4" placeholder="åœ¨æ­¤ç²˜è´´åå•æˆ–è¾“å…¥å§“å...">
                
                <div class="flex justify-between items-center">
                    <button id="ld-clear-btn" class="btn bg-red-500 hover:bg-red-400 text-black font-bold shadow-md transition-all">æ¸…ç©ºåå•</button>
                    <button id="ld-pick-btn" class="btn btn-warning px-14 text-lg shadow-lg">å¼€å§‹æŠ½å¥–</button>
                </div>
            </div>

            <div id="ld-result-view" class="app-card hidden flex-col items-center">
                <h3 id="ld-result-status" class="text-xl font-bold text-blue-400 mb-8 uppercase tracking-widest">æŠ½å¥–è¿›è¡Œä¸­...</h3>
                <div id="ld-result-card" class="w-full py-20 bg-blue-600 rounded-2xl text-6xl font-black shadow-2xl border-4 border-blue-400 text-white text-center transition-all duration-300">
                    <span id="ld-chosen-name">Ready?</span>
                </div>
                <button id="ld-go-back-btn" class="mt-10 btn border border-slate-600 px-10 bg-slate-800 text-white font-bold hidden">â† è¿”å›ç¼–è¾‘åˆ—è¡¨</button>
            </div>
        </div>

        <!-- App: Grouping -->
        <div id="app-grouping" class="app-content">
            <div id="gp-setup-page" class="app-card">
                <h2 class="text-2xl font-bold mb-6 text-center text-white">ğŸ‰ éšæœºåˆ†ç»„</h2>
                
                <!-- Class Manager UI -->
                <div class="class-manager-bar">
                    <span class="text-xs font-bold text-slate-400 uppercase tracking-wider hidden sm:inline">ç­çº§:</span>
                    <select id="gp-class-select" class="class-select">
                        <option value="">-- é€‰æ‹©ç­çº§ --</option>
                    </select>
                    <button id="gp-save-class-btn" class="class-btn class-btn-save" title="ä¿å­˜å½“å‰åå•">ğŸ’¾ <span class="hidden sm:inline">ä¿å­˜</span></button>
                    <button id="gp-share-class-btn" class="class-btn class-btn-link" title="ç”Ÿæˆåˆ†äº«é“¾æ¥">ğŸ”— <span class="hidden sm:inline">åˆ†äº«</span></button>
                    <button id="gp-del-class-btn" class="class-btn class-btn-del" title="åˆ é™¤ç­çº§">ğŸ—‘ï¸</button>
                </div>

                <div id="gp-name-display" class="tag-container mb-4"></div>
                <input type="text" id="gp-name-input" class="form-input mb-6" placeholder="åœ¨æ­¤ç²˜è´´åå•æˆ–è¾“å…¥å§“å...">
                
                <div class="mode-selector">
                    <div class="mode-btn active" data-mode="count">æŒ‰ç»„æ•°åˆ†</div>
                    <div class="mode-btn" data-mode="size">æŒ‰æ¯ç»„äººæ•°åˆ†</div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="p-4 bg-slate-800/50 border border-slate-700 rounded-xl flex flex-col items-center justify-center">
                        <label id="gp-label" class="form-label text-center mb-3">éœ€è¦åˆ†å¤šå°‘ç»„ï¼Ÿ</label>
                        <div class="flex items-center gap-3">
                            <button id="gp-btn-minus" class="w-12 h-12 rounded-xl bg-slate-700 hover:bg-slate-600 active:scale-95 text-white font-bold text-2xl transition-all border border-slate-600 shadow-md flex items-center justify-center leading-none pb-1">-</button>
                            <input type="number" id="gp-value" value="2" min="1" class="w-20 bg-transparent text-center text-4xl font-black text-white border-none focus:ring-0 p-0 appearance-none" style="-moz-appearance: textfield;">
                            <button id="gp-btn-plus" class="w-12 h-12 rounded-xl bg-slate-700 hover:bg-slate-600 active:scale-95 text-white font-bold text-2xl transition-all border border-slate-600 shadow-md flex items-center justify-center leading-none pb-1">+</button>
                        </div>
                    </div>
                    <button id="gp-start-btn" class="btn btn-primary text-xl shadow-lg">æ‰§è¡Œéšæœºåˆ†ç»„</button>
                </div>

                <div class="flex justify-start">
                    <button id="gp-clear-btn" class="btn bg-red-500 hover:bg-red-400 text-black font-bold shadow-md transition-all">æ¸…ç©ºåå•</button>
                </div>
            </div>
            
            <div id="gp-results-page" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <button id="gp-back-btn" class="btn border border-slate-600 bg-slate-800 text-white text-sm">â† è¿”å›è®¾ç½®</button>
                    <div class="flex gap-2">
                        <button id="gp-download-btn" class="btn bg-green-600 hover:bg-green-500 text-white text-sm">ğŸ“¥ HTML</button>
                        <button id="gp-export-img-btn" class="btn bg-purple-600 hover:bg-purple-500 text-white text-sm">ğŸ–¼ï¸ å›¾ç‰‡</button>
                    </div>
                </div>
                <div id="gp-results-container" class="flex flex-wrap justify-center gap-6 pb-10 p-6 bg-slate-100/5 rounded-xl"></div>
            </div>
        </div>

        <!-- App: Exam Timer -->
        <div id="app-exam-timer" class="app-content">
            <div id="exam-setup-screen" class="app-card max-w-lg mx-auto">
                <h2 class="text-2xl font-bold mb-6 text-center text-white">â±ï¸ è€ƒè¯•å€’æ•°è®¾ç½®</h2>
                <div class="space-y-5">
                    <div>
                        <label class="form-label">è€ƒè¯•ç§‘ç›® / æ ‡é¢˜</label>
                        <input type="text" id="exam-title-input" class="form-input" placeholder="ä¾‹å¦‚ï¼šåæ–‡æµ‹éªŒ">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="form-label">å¼€å§‹æ—¶é—´</label>
                            <input type="time" id="exam-start-input" class="form-input">
                        </div>
                        <div>
                            <label class="form-label">è€ƒè¯•æ—¶é•¿ (åˆ†é’Ÿ)</label>
                            <input type="number" id="exam-duration-input" class="form-input" value="60">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
                        <button id="exam-set-btn" class="btn bg-slate-700 hover:bg-slate-600 text-slate-200 font-bold py-4 border border-slate-600 shadow-sm">
                            æŒ‰è®¾å®šæ—¶é—´å¼€å§‹
                        </button>
                        <button id="exam-start-now-btn" class="btn btn-primary text-xl font-bold py-4 shadow-xl">
                            ğŸš€ é©¬ä¸Šå¼€å§‹
                        </button>
                    </div>
                </div>
            </div>

            <div id="exam-dashboard-screen" class="hidden space-y-6">
                <div class="app-card flex justify-between items-center bg-slate-800/80 border-blue-500/30 py-4">
                    <h2 id="exam-display-title" class="text-2xl font-black text-blue-400 px-2">--</h2>
                    <div class="text-right px-2">
                        <div id="exam-status-label" class="text-xs text-muted font-bold uppercase tracking-widest">é¢„è®¡ç»“æŸæ—¶é—´</div>
                        <div id="exam-end-time-display" class="text-2xl font-mono text-white font-bold">00:00:00</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="app-card flex flex-col items-center justify-center bg-slate-900/40">
                        <div id="clock-container"></div> 
                        <div class="mt-6 flex flex-col items-center">
                            <span class="text-xs text-muted font-bold tracking-widest uppercase mb-1">ç³»ç»Ÿå½“å‰æ—¶é—´</span>
                            <div id="exam-sys-time" class="text-3xl font-mono text-blue-400 bg-slate-950 px-6 py-2 rounded-xl border border-slate-700 shadow-inner">00:00:00</div>
                        </div>
                    </div>
                    <div class="app-card flex flex-col items-center justify-center text-center bg-slate-800/40">
                        <p id="exam-timer-label" class="text-muted uppercase tracking-widest text-sm font-bold mb-4">è€ƒè¯•å‰©ä½™æ—¶é—´</p>
                        <div id="exam-big-timer" class="big-timer">00:00</div>
                        <div class="flex gap-4 mt-12 w-full max-w-xs">
                            <button id="exam-pause-btn" class="btn bg-slate-700 hover:bg-slate-600 flex-1 text-lg">æš‚åœ</button>
                            <button id="exam-reset-btn" class="btn bg-red-900/40 text-red-400 border border-red-500/30 hover:bg-red-900/60 flex-1 text-lg">Reset</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="mt-auto pt-10 pb-4 text-center">
            <p class="text-slate-600 text-xs font-medium tracking-widest uppercase">
                &copy; <span id="footer-year"></span> ç¬¦è€å¸ˆå·¥å…·ç®± | Created by ç¬¦è€å¸ˆ
            </p>
        </footer>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Custom Save Modal -->
    <div id="save-class-modal" class="fixed inset-0 bg-black/70 hidden flex items-center justify-center z-50">
        <div class="bg-slate-800 p-6 rounded-xl border border-slate-600 w-80 shadow-2xl">
            <h3 class="text-lg font-bold text-white mb-4">ğŸ’¾ ä¿å­˜ç­çº§åå•</h3>
            <input type="text" id="save-class-name-input" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-white mb-4 focus:outline-none focus:border-blue-500" placeholder="è¯·è¾“å…¥ç­çº§åç§° (å¦‚: 5A)">
            <div class="flex justify-end gap-2">
                <button id="save-class-cancel-btn" class="text-slate-400 hover:text-white px-3 py-1.5 text-sm">å–æ¶ˆ</button>
                <button id="save-class-confirm-btn" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-1.5 rounded text-sm font-bold">ç¡®å®šä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- URL Import Modal -->
    <div id="url-import-modal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center z-50">
        <div class="bg-slate-800 p-6 rounded-xl border border-slate-600 w-96 shadow-2xl">
            <h3 class="text-xl font-bold text-white mb-2">ğŸ“¥ å¯¼å…¥åˆ†äº«ç­çº§</h3>
            <p id="url-import-msg" class="text-slate-300 mb-6">æ£€æµ‹åˆ°åˆ†äº«çš„ç­çº§: <span id="url-import-name" class="font-bold text-blue-400"></span></p>
            <div class="flex justify-end gap-3">
                <button id="url-import-cancel" class="text-slate-400 hover:text-white px-4 py-2">å¿½ç•¥</button>
                <button id="url-import-confirm" class="bg-emerald-600 hover:bg-emerald-500 text-white px-6 py-2 rounded font-bold shadow-lg">ç«‹å³å¯¼å…¥</button>
            </div>
        </div>
    </div>

    <script>
        const $ = (s, r = document) => r.querySelector(s);
        const $$ = (s, r = document) => r.querySelectorAll(s);

        // Set dynamic year in footer
        $('#footer-year').textContent = new Date().getFullYear();

        // --- Core Helpers ---
        function runConfetti() {
            if (typeof confetti === 'undefined') return;
            confetti({ particleCount: 150, spread: 90, origin: { y: 0.6 } });
            confetti({ particleCount: 50, angle: 60, spread: 55, origin: { x: 0 } });
            confetti({ particleCount: 50, angle: 120, spread: 55, origin: { x: 1 } });
        }

        // --- Toast System (Replaces Alert) ---
        window.showToast = (msg, type = 'success') => {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            el.className = `toast ${type}`;
            el.innerHTML = `<span>${msg}</span><button onclick="this.parentElement.remove()" class="ml-2 opacity-50 hover:opacity-100">Ã—</button>`;
            container.appendChild(el);
            setTimeout(() => { 
                el.style.opacity = '0'; 
                el.style.transform = 'translateX(100%)';
                setTimeout(() => el.remove(), 300);
            }, 3000);
        };

        // --- Function to Refresh Dropdowns ---
        function refreshClassDropdowns() {
            if (!window.ClassDB) return; 
            const classes = window.ClassDB.getClasses();
            const selects = ['#ld-class-select', '#gp-class-select'];
            
            selects.forEach(selId => {
                const el = $(selId);
                const currentVal = el.value;
                el.innerHTML = '<option value="">-- åŠ è½½å·²ä¿å­˜ç­çº§ --</option>';
                Object.keys(classes).forEach(clsName => {
                    const opt = document.createElement('option');
                    opt.value = clsName;
                    opt.textContent = `${clsName} (${classes[clsName].length}äºº)`;
                    el.appendChild(opt);
                });
                if(currentVal && classes[currentVal]) el.value = currentVal; 
            });
        }

        // --- Class Data Management (Local + File + URL) ---
        const ClassDB = {
            key: 'mr_fu_classes_v1',
            getClasses: function() {
                const stored = localStorage.getItem(this.key);
                return stored ? JSON.parse(stored) : {};
            },
            saveClass: function(name, list) {
                if (!name || !list || list.length === 0) return false;
                const classes = this.getClasses();
                classes[name] = list;
                localStorage.setItem(this.key, JSON.stringify(classes));
                return true;
            },
            deleteClass: function(name) {
                const classes = this.getClasses();
                if (classes[name]) {
                    delete classes[name];
                    localStorage.setItem(this.key, JSON.stringify(classes));
                    return true;
                }
                return false;
            },
            // Export ALL data to a JSON file
            exportToFile: function() {
                const data = this.getClasses();
                if (Object.keys(data).length === 0) {
                    showToast("âš ï¸ æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®", "error");
                    return;
                }
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `fu-teacher-backup-${new Date().toISOString().slice(0,10)}.json`;
                a.click();
                URL.revokeObjectURL(url);
                showToast("âœ… å¤‡ä»½æ–‡ä»¶å·²ä¸‹è½½ï¼", "success");
            },
            // Import data from a JSON file
            importFromFile: function(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (typeof data === 'object' && data !== null) {
                            const current = this.getClasses();
                            const merged = { ...current, ...data };
                            localStorage.setItem(this.key, JSON.stringify(merged));
                            refreshClassDropdowns();
                            showToast(`âœ… æˆåŠŸæ¢å¤ ${Object.keys(data).length} ä¸ªç­çº§ï¼`, "success");
                        } else {
                            throw new Error("Invalid format");
                        }
                    } catch (err) {
                        showToast("âŒ æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œæ— æ³•å¯¼å…¥", "error");
                    }
                };
                reader.readAsText(file);
            },
            // Magic Link Logic
            generateLink: function(name) {
                const classes = this.getClasses();
                if(!classes[name]) return null;
                // Simple B64 encoding of JSON string
                const dataStr = JSON.stringify({ n: name, l: classes[name] });
                const encoded = btoa(encodeURIComponent(dataStr));
                const url = `${window.location.protocol}//${window.location.host}${window.location.pathname}?data=${encoded}`;
                return url;
            }
        };

        window.ClassDB = ClassDB;

        // --- File Backup UI Logic ---
        $('#btn-file-export').onclick = () => ClassDB.exportToFile();
        $('#btn-file-import').onclick = () => $('#file-import-input').click();
        $('#file-import-input').onchange = (e) => {
            if (e.target.files.length > 0) {
                ClassDB.importFromFile(e.target.files[0]);
                e.target.value = '';
            }
        };

        // --- URL Import Checker ---
        window.addEventListener('load', () => {
            const params = new URLSearchParams(window.location.search);
            const dataParam = params.get('data');
            if(dataParam) {
                try {
                    const decoded = decodeURIComponent(atob(dataParam));
                    const importData = JSON.parse(decoded);
                    if(importData.n && importData.l) {
                        $('#url-import-name').textContent = importData.n;
                        $('#url-import-modal').classList.remove('hidden');
                        
                        $('#url-import-confirm').onclick = () => {
                            ClassDB.saveClass(importData.n, importData.l);
                            refreshClassDropdowns();
                            $('#url-import-modal').classList.add('hidden');
                            showToast(`âœ… ç­çº§ "${importData.n}" å·²å¯¼å…¥ï¼`, "success");
                            // Clear URL
                            window.history.replaceState({}, document.title, window.location.pathname);
                        };
                        
                        $('#url-import-cancel').onclick = () => {
                            $('#url-import-modal').classList.add('hidden');
                            window.history.replaceState({}, document.title, window.location.pathname);
                        };
                    }
                } catch(e) {
                    console.error("Link Parse Error", e);
                }
            }
        });

        // --- Name System Manager ---
        let pendingSaveList = null;
        let pendingSelectId = null;

        function createNameManager(inputId, containerId, pickBtnId = null, selectId = null, saveBtnId = null, shareBtnId = null, delBtnId = null) {
            const list = [];
            const input = $(inputId);
            const container = $(containerId);
            const pickBtn = pickBtnId ? $(pickBtnId) : null;

            const render = () => {
                container.innerHTML = list.length ? '' : '<span class="text-slate-500 italic flex items-center h-full w-full justify-center opacity-60">åå•ä¸ºç©ºï¼Œè¯·ç²˜è´´æˆ–è¾“å…¥å§“å...</span>';
                list.forEach((name, i) => {
                    const tag = document.createElement('span');
                    tag.className = 'tag';
                    tag.innerHTML = `${name}<span class="remove" data-idx="${i}">Ã—</span>`;
                    container.appendChild(tag);
                });
                if (pickBtn) pickBtn.disabled = list.length === 0;
                container.scrollTop = container.scrollHeight;
            };

            const process = (text) => {
                const rawNames = text.split(/[,\s\n\tï¼Œã€ï¼›;]+/).filter(n => n.trim() !== "");
                rawNames.forEach(n => {
                    if (!list.includes(n)) list.push(n);
                });
                render();
            };

            input.onkeydown = (e) => { if (e.key === 'Enter') { e.preventDefault(); process(input.value); input.value = ''; } };
            input.onpaste = (e) => { e.preventDefault(); process((e.clipboardData || window.clipboardData).getData('text')); input.value = ''; };
            container.onclick = (e) => { if (e.target.classList.contains('remove')) { list.splice(e.target.dataset.idx, 1); render(); } };

            // Class Manager Events
            if (selectId) {
                $(selectId).onchange = (e) => {
                    const clsName = e.target.value;
                    if (clsName && window.ClassDB) {
                        const classes = window.ClassDB.getClasses();
                        if (classes[clsName]) {
                            list.length = 0;
                            list.push(...classes[clsName]);
                            render();
                            showToast(`å·²åŠ è½½ ${clsName}`);
                        }
                    }
                };
            }

            if (saveBtnId) {
                $(saveBtnId).onclick = () => {
                    if (list.length === 0) return showToast("åå•ä¸ºç©ºï¼Œæ— æ³•ä¿å­˜", "error");
                    $('#save-class-name-input').value = '';
                    $('#save-class-modal').classList.remove('hidden');
                    $('#save-class-name-input').focus();
                    pendingSaveList = list;
                    pendingSelectId = selectId;
                };
            }

            if (shareBtnId) {
                $(shareBtnId).onclick = () => {
                    const clsName = $(selectId).value;
                    if (!clsName) return showToast("è¯·å…ˆåœ¨å·¦ä¾§é€‰æ‹©ä¸€ä¸ªç­çº§", "error");
                    const link = ClassDB.generateLink(clsName);
                    if (link) {
                        // Copy to clipboard fallback
                        const textArea = document.createElement("textarea");
                        textArea.value = link;
                        document.body.appendChild(textArea);
                        textArea.select();
                        try {
                            document.execCommand('copy');
                            showToast("ğŸ”— é“¾æ¥å·²å¤åˆ¶ï¼å‘é€ç»™å¦ä¸€å°ç”µè„‘å³å¯å¯¼å…¥", "info");
                        } catch (err) {
                            prompt("è¯·å¤åˆ¶æ­¤é“¾æ¥åˆ†äº«:", link);
                        }
                        document.body.removeChild(textArea);
                    }
                };
            }

            if (delBtnId) {
                $(delBtnId).onclick = () => {
                    const selectEl = $(selectId);
                    const clsName = selectEl.value;
                    if (!clsName) return showToast("è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„ç­çº§", "error");
                    if(window.ClassDB) {
                        window.ClassDB.deleteClass(clsName);
                        refreshClassDropdowns();
                        selectEl.value = ""; 
                        showToast(`å·²åˆ é™¤ç­çº§: ${clsName}`, "success");
                    }
                };
            }

            return { list, render, clear: () => { list.length = 0; render(); if(selectId) $(selectId).value = ""; } };
        }

        // Global Modal Event Handlers
        $('#save-class-confirm-btn').onclick = () => {
            const name = $('#save-class-name-input').value.trim();
            if (!name) return showToast("è¯·è¾“å…¥åç§°", "error");
            
            if (window.ClassDB && pendingSaveList) {
                window.ClassDB.saveClass(name, pendingSaveList);
                refreshClassDropdowns();
                showToast(`ç­çº§ "${name}" å·²ä¿å­˜!`);
                if(pendingSelectId) $(pendingSelectId).value = name;
            }
            $('#save-class-modal').classList.add('hidden');
            pendingSaveList = null;
        };

        $('#save-class-cancel-btn').onclick = () => {
            $('#save-class-modal').classList.add('hidden');
            pendingSaveList = null;
        };

        // --- Lucky Draw Logic ---
        const ldMgr = createNameManager(
            '#ld-name-input', 
            '#ld-tag-container', 
            '#ld-pick-btn',
            '#ld-class-select',
            '#ld-save-class-btn',
            '#ld-share-class-btn',
            '#ld-del-class-btn'
        );
        let shuffleInterval = null;

        function showLdView(viewId) {
            if (viewId === 'home') {
                $('#ld-home-view').classList.remove('hidden');
                $('#ld-result-view').classList.add('hidden');
                $('#ld-result-card').classList.remove('chosen-card');
                $('#ld-go-back-btn').classList.add('hidden');
            } else {
                $('#ld-home-view').classList.add('hidden');
                $('#ld-result-view').classList.remove('hidden');
                $('#ld-result-view').classList.add('flex');
            }
        }

        const visualShuffle = (names) => {
            const randomIndex = Math.floor(Math.random() * names.length);
            $('#ld-chosen-name').textContent = names[randomIndex];
        };

        $('#ld-pick-btn').onclick = () => {
            const names = ldMgr.list;
            if (names.length === 0) return;
            showLdView('result');
            let speed = 60;
            shuffleInterval = setInterval(() => visualShuffle(names), speed);
            setTimeout(() => { clearInterval(shuffleInterval); speed = 150; shuffleInterval = setInterval(() => visualShuffle(names), speed); }, 1200);
            setTimeout(() => { clearInterval(shuffleInterval); speed = 400; shuffleInterval = setInterval(() => visualShuffle(names), speed); }, 2200);
            setTimeout(() => {
                clearInterval(shuffleInterval);
                const winner = names[Math.floor(Math.random() * names.length)];
                $('#ld-chosen-name').textContent = winner;
                $('#ld-result-status').textContent = "ğŸ¥³ å¾—å¥–çš„æ˜¯... ğŸ¥³";
                $('#ld-result-card').classList.add('chosen-card');
                runConfetti();
                $('#ld-go-back-btn').classList.remove('hidden');
            }, 3500);
        };
        $('#ld-go-back-btn').onclick = () => showLdView('home');
        $('#ld-clear-btn').onclick = () => { ldMgr.clear(); };

        // --- Grouping Logic ---
        const gpMgr = createNameManager(
            '#gp-name-input', 
            '#gp-name-display', 
            '#gp-start-btn',
            '#gp-class-select',
            '#gp-save-class-btn',
            '#gp-share-class-btn',
            '#gp-del-class-btn'
        );
        let gpMode = 'count';
        const colorPalette = ['group-color-1', 'group-color-2', 'group-color-3', 'group-color-4', 'group-color-5', 'group-color-6', 'group-color-7', 'group-color-8'];

        $$('.mode-btn').forEach(btn => {
            btn.onclick = () => {
                $$('.mode-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                gpMode = btn.dataset.mode;
                $('#gp-label').textContent = gpMode === 'count' ? 'éœ€è¦åˆ†å¤šå°‘ç»„ï¼Ÿ' : 'æ¯ç»„å¤šå°‘äººï¼Ÿ';
            };
        });

        $('#gp-btn-minus').onclick = () => {
            const input = $('#gp-value');
            let val = parseInt(input.value) || 0;
            if (val > 1) input.value = val - 1;
        };

        $('#gp-btn-plus').onclick = () => {
            const input = $('#gp-value');
            let val = parseInt(input.value) || 0;
            input.value = val + 1;
        };

        $('#gp-clear-btn').onclick = () => { gpMgr.clear(); };

        function revealNamesOneByOne() {
            const namesToReveal = document.querySelectorAll('.name-reveal');
            let delay = 0;
            const interval = 200; 
            namesToReveal.forEach((nameEl) => {
                setTimeout(() => { nameEl.classList.add('visible'); }, delay);
                delay += interval;
            });
        }

        function buildResultsCards(groups) {
            const resultsContainer = $('#gp-results-container');
            resultsContainer.innerHTML = '';
            
            groups.forEach((groupNames, index) => {
                const colorClass = colorPalette[index % colorPalette.length];
                const card = document.createElement('div');
                card.className = `group-card-colors ${colorClass} w-full sm:w-64 bg-white rounded-lg shadow-md overflow-hidden flex-shrink-0 mb-4 transform transition-all hover:scale-105`;
                
                const headerStyle = `background-color: var(--color-header-bg); color: var(--color-header-text);`;
                const bodyStyle = `background-color: var(--color-bg); color: var(--color-text);`;

                const header = document.createElement('div');
                header.className = 'p-3 flex justify-between items-center';
                header.setAttribute('style', headerStyle);
                header.innerHTML = `
                    <h3 class="text-lg font-bold">Group ${index + 1}</h3>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 opacity-80" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a2 2 0 00-2-2H6a2 2 0 00-2 2v3h12z" />
                    </svg>`;
                
                const body = document.createElement('ul');
                body.className = 'divide-y divide-gray-200/20'; 
                body.setAttribute('style', bodyStyle);

                if (groupNames.length === 0) {
                    body.innerHTML = '<li class="px-4 py-3 text-sm italic opacity-70">Empty</li>';
                } else {
                    groupNames.forEach((name, i) => {
                        const li = document.createElement('li');
                        li.className = 'name-reveal px-4 py-3 text-sm font-medium flex items-center';
                        if (i % 2 === 1) li.style.backgroundColor = 'rgba(255,255,255,0.2)';
                        li.textContent = name;
                        body.appendChild(li);
                    });
                }
                
                card.appendChild(header);
                card.appendChild(body);
                resultsContainer.appendChild(card);
            });
            revealNamesOneByOne();
        }

        $('#gp-start-btn').onclick = () => {
            const val = parseInt($('#gp-value').value);
            if (!val || val < 1 || gpMgr.list.length < 2) return;

            const shuffled = [...gpMgr.list].sort(() => Math.random() - 0.5);
            let groups = [];

            if (gpMode === 'count') {
                const groupCount = Math.min(val, shuffled.length);
                groups = Array.from({ length: groupCount }, () => []);
                shuffled.forEach((name, i) => groups[i % groupCount].push(name));
            } else {
                for (let i = 0; i < shuffled.length; i += val) {
                    groups.push(shuffled.slice(i, i + val));
                }
            }
            
            buildResultsCards(groups);
            $('#gp-setup-page').classList.add('hidden');
            $('#gp-results-page').classList.remove('hidden');
        };

        $('#gp-back-btn').onclick = () => { $('#gp-setup-page').classList.remove('hidden'); $('#gp-results-page').classList.add('hidden'); };
        
        $('#gp-download-btn').onclick = () => {
            const resultsHTML = $('#gp-results-container').innerHTML;
            const styles = `
                <script src="https://cdn.tailwindcss.com"><\/script>
                <style>
                    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; padding: 20px; }
                    .group-card-colors { --color-bg: #e0e7ff; --color-text: #3730a3; --color-header-bg: #4f46e5; --color-header-text: #ffffff; }
                    .group-color-1 { --color-bg: #dbeafe; --color-text: #1e40af; --color-header-bg: #2563eb; }
                    .group-color-2 { --color-bg: #d1fae5; --color-text: #065f46; --color-header-bg: #10b981; }
                    .group-color-3 { --color-bg: #fef3c7; --color-text: #92400e; --color-header-bg: #f59e0b; }
                    .group-color-4 { --color-bg: #fee2e2; --color-text: #991b1b; --color-header-bg: #ef4444; }
                    .group-color-5 { --color-bg: #f3e8ff; --color-text: #581c87; --color-header-bg: #9333ea; }
                    .group-color-6 { --color-bg: #ffe4e6; --color-text: #9f1239; --color-header-bg: #e11d48; }
                    .group-color-7 { --color-bg: #e0f2fe; --color-text: #075985; --color-header-bg: #0ea5e9; }
                    .group-color-8 { --color-bg: #dcfce7; --color-text: #166534; --color-header-bg: #22c55e; }
                    .name-reveal { opacity: 1 !important; transform: none !important; }
                </style>`;
            
            const htmlContent = `
                <!DOCTYPE html><html lang="en">
                <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>åˆ†ç»„ç»“æœ - ç¬¦è€å¸ˆå·¥å…·ç®±</title>${styles}</head>
                <body>
                    <h1 class="text-3xl font-bold text-center mb-8 text-gray-800">åˆ†ç»„ç»“æœ (Generated Groups)</h1>
                    <div class="flex flex-wrap justify-center gap-6">${resultsHTML}</div>
                </body></html>`;
            
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `student-groups-${new Date().toISOString().slice(0,10)}.html`;
            a.click();
            URL.revokeObjectURL(a.href);
        };

        $('#gp-export-img-btn').onclick = async () => {
            const container = $('#gp-results-container');
            showToast("æ­£åœ¨ç”Ÿæˆå›¾ç‰‡ï¼Œè¯·ç¨å€™...", "success");

            try {
                const canvas = await html2canvas(container, {
                    scale: 2,
                    backgroundColor: '#1f2937', 
                    logging: false,
                    useCORS: true
                });

                const link = document.createElement('a');
                link.download = `grouping-result-${new Date().toISOString().slice(0,10)}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                showToast("å›¾ç‰‡å·²ä¸‹è½½ï¼", "success");
            } catch (err) {
                console.error(err);
                showToast("å›¾ç‰‡ç”Ÿæˆå¤±è´¥", "error");
            }
        };

        // --- Exam Timer Logic (Fully Synced) ---
        let examStart = null;
        let examEnd = null;
        let isPaused = false;
        let pauseLeft = 0; 
        let pauseLeftWait = 0; 
        let examState = 'idle';

        // Initialize SVG Clock
        function initClock() {
            const container = $('#clock-container');
            if(container.innerHTML) return;
            
            let t = `<svg id="exam-analog-clock" width="280" height="280" viewBox="0 0 220 220">
                <circle cx="110" cy="110" r="100" class="clock-face"/>`;
            for (let i = 0; i < 60; i++) {
                const a = i * 6 * Math.PI / 180;
                const maj = i % 5 === 0;
                t += `<line x1="${110+98*Math.sin(a)}" y1="${110-98*Math.cos(a)}" x2="${110+(maj?85:92)*Math.sin(a)}" y2="${110-(maj?85:92)*Math.cos(a)}" class="${maj?'tick-major':'tick-minor'}"/>`;
                if (maj) t += `<text x="${110+75*Math.sin(a)}" y="${110-75*Math.cos(a)+5}" class="clock-num" text-anchor="middle">${i===0?12:i/5}</text>`;
            }
            t += `<line id="h-hour" x1="110" y1="110" x2="110" y2="65" class="h-hour"/><line id="h-min" x1="110" y1="110" x2="110" y2="50" class="h-min"/><line id="h-sec" x1="110" y1="110" x2="110" y2="40" class="h-sec"/><circle cx="110" cy="110" r="4" class="h-cap"/></svg>`;
            container.innerHTML = t;
        }

        function formatTime(sec) {
            const h = Math.floor(sec / 3600);
            const m = Math.floor((sec % 3600) / 60);
            const s = sec % 60;
            return `${h>0?h+':':''}${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        }

        // --- Unified High-Frequency Loop ---
        function startUnifiedLoop() {
            initClock();
            const hSec = $('#h-sec');
            const hMin = $('#h-min');
            const hHour = $('#h-hour');
            const sysTime = $('#exam-sys-time');
            const bigTimer = $('#exam-big-timer');

            function step() {
                const now = new Date();
                
                // 1. Update Analog Clock (Tick style)
                const s = now.getSeconds();
                const m = now.getMinutes();
                const h = now.getHours();

                // Discrete ticking seconds
                const sAngle = s * 6;
                const mAngle = m * 6 + s * 0.1;
                const hAngle = (h % 12) * 30 + m * 0.5;

                if(hSec) hSec.setAttribute('transform', `rotate(${sAngle}, 110, 110)`);
                if(hMin) hMin.setAttribute('transform', `rotate(${mAngle}, 110, 110)`);
                if(hHour) hHour.setAttribute('transform', `rotate(${hAngle}, 110, 110)`);
                
                // 2. Update System Digital Time
                if(sysTime) sysTime.textContent = now.toTimeString().split(' ')[0];

                // 3. Update Exam Countdown (Synced)
                if (!isPaused && examEnd) {
                    if (examState === 'waiting') {
                        const diff = Math.ceil((examStart - now) / 1000);
                        if (diff <= 0) {
                            examState = 'running';
                            $('#exam-timer-label').textContent = "è€ƒè¯•å‰©ä½™æ—¶é—´";
                            $('#exam-status-label').textContent = "é¢„è®¡ç»“æŸæ—¶é—´";
                            $('#exam-big-timer').classList.remove('waiting');
                            $('#exam-end-time-display').textContent = examEnd.toTimeString().split(' ')[0];
                            showToast("è€ƒè¯•å¼€å§‹ï¼");
                        } else {
                            if(bigTimer) bigTimer.textContent = formatTime(diff);
                        }
                    } else if (examState === 'running') {
                        const diff = Math.max(0, Math.ceil((examEnd - now) / 1000));
                        if(bigTimer) bigTimer.textContent = formatTime(diff);
                        
                        if (diff < 60) $('#exam-big-timer').classList.add('critical');
                        else $('#exam-big-timer').classList.remove('critical');
                        
                        if (diff === 0) { 
                            examState = 'finished';
                            showToast("è€ƒè¯•æ—¶é—´åˆ°ï¼", "error");
                            // Play sound here if needed
                        }
                    }
                }

                requestAnimationFrame(step);
            }
            requestAnimationFrame(step);
        }

        function startExam(isImmediate) {
            const dur = parseInt($('#exam-duration-input').value);
            const title = $('#exam-title-input').value || "è€ƒè¯•å€’è®¡æ—¶";
            
            let startTime = new Date();
            let isFutureStart = false;

            if (!isImmediate && $('#exam-start-input').value) {
                const [h, m] = $('#exam-start-input').value.split(':');
                const tempStart = new Date();
                tempStart.setHours(h, m, 0, 0);
                
                if (tempStart > new Date(Date.now() + 5000)) {
                    startTime = tempStart;
                    isFutureStart = true;
                }
            }

            examStart = startTime;
            examEnd = new Date(startTime.getTime() + dur * 60000);
            
            $('#exam-display-title').textContent = title;
            $('#exam-setup-screen').classList.add('hidden');
            $('#exam-dashboard-screen').classList.remove('hidden');
            
            isPaused = false;
            
            if (isFutureStart) {
                examState = 'waiting';
                $('#exam-timer-label').textContent = "è·ç¦»è€ƒè¯•å¼€å§‹";
                $('#exam-status-label').textContent = "è®¡åˆ’å¼€å§‹æ—¶é—´";
                $('#exam-end-time-display').textContent = examStart.toTimeString().split(' ')[0];
                $('#exam-big-timer').classList.add('waiting');
            } else {
                examState = 'running';
                $('#exam-timer-label').textContent = "è€ƒè¯•å‰©ä½™æ—¶é—´";
                $('#exam-status-label').textContent = "é¢„è®¡ç»“æŸæ—¶é—´";
                $('#exam-end-time-display').textContent = examEnd.toTimeString().split(' ')[0];
                $('#exam-big-timer').classList.remove('waiting');
            }
        }

        $('#exam-set-btn').onclick = () => startExam(false);
        $('#exam-start-now-btn').onclick = () => startExam(true);

        $('#exam-pause-btn').onclick = () => {
            if (!examEnd) return;
            isPaused = !isPaused;
            const now = new Date();

            if (isPaused) {
                if (examState === 'waiting') {
                    pauseLeftWait = examStart - now; 
                    pauseLeft = examEnd - examStart; 
                } else if (examState === 'running') {
                    pauseLeft = examEnd - now;
                }
                
                $('#exam-pause-btn').textContent = "ç»§ç»­";
                $('#exam-pause-btn').classList.add('bg-blue-600');
            } else {
                if (examState === 'waiting') {
                    examStart = new Date(now.getTime() + pauseLeftWait);
                    examEnd = new Date(examStart.getTime() + pauseLeft);
                    $('#exam-end-time-display').textContent = examStart.toTimeString().split(' ')[0];
                } else if (examState === 'running') {
                    examEnd = new Date(now.getTime() + pauseLeft);
                    $('#exam-end-time-display').textContent = examEnd.toTimeString().split(' ')[0];
                }

                $('#exam-pause-btn').textContent = "æš‚åœ";
                $('#exam-pause-btn').classList.remove('bg-blue-600');
            }
        };

        $('#exam-reset-btn').onclick = () => {
            examEnd = null;
            examStart = null;
            isPaused = false;
            examState = 'idle';
            
            $('#exam-setup-screen').classList.remove('hidden');
            $('#exam-dashboard-screen').classList.add('hidden');
            $('#exam-big-timer').textContent = "00:00";
            $('#exam-big-timer').classList.remove('critical');
            $('#exam-big-timer').classList.remove('waiting');
            $('#exam-pause-btn').textContent = "æš‚åœ";
            $('#exam-pause-btn').classList.remove('bg-blue-600');
        };

        // --- Navigation ---
        $$('.nav-btn').forEach(btn => {
            btn.onclick = () => {
                $$('.nav-btn').forEach(b => b.classList.remove('active'));
                $$('.app-content').forEach(a => a.classList.remove('active'));
                btn.classList.add('active');
                
                const targetId = btn.id.replace('nav-', 'app-');
                $( `#${targetId}` ).classList.add('active');
            };
        });

        $('#sidebar-toggle').onclick = () => document.body.classList.toggle('sidebar-retracted');

        // Initial Start
        const iNow = new Date();
        $('#exam-start-input').value = `${String(iNow.getHours()).padStart(2,'0')}:${String(iNow.getMinutes()).padStart(2,'0')}`;
        
        // Wait for modules to load before refreshing dropdowns
        setTimeout(() => refreshClassDropdowns(), 1000);
        startUnifiedLoop(); 
    </script>
</body>
</html>
