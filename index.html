<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•™å¸ˆå·¥å…·ç®±</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.0/dist/confetti.browser.js"></script>

    <style>
        :root {
            --bg-color: #0f172a;
            --panel-color: #1e293b;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --color-success: #10b981;
            --color-warning: #f59e0b;
            --color-danger: #ef4444;
            --color-accent: #3b82f6;
            --font-stack: 'Inter', 'Noto Sans SC', system-ui, -apple-system, sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
        }

        * { box-sizing: border-box; }
        body {
            font-family: var(--font-stack);
            background-color: var(--bg-color);
            color: var(--text-main);
            height: 100vh; width: 100vw; overflow: hidden; display: flex;
            line-height: 1.5;
        }

        /* --- Sidebar --- */
        #sidebar {
            width: 260px; flex-shrink: 0; background-color: var(--panel-color);
            padding: 1.5rem; border-right: 1px solid #334155; transition: margin-left 0.3s ease;
            display: flex; flex-direction: column;
        }
        body.sidebar-retracted #sidebar { margin-left: -260px; }
        .brand-title { font-size: 1.5rem; font-weight: 800; text-align: center; margin-bottom: 0.5rem; color: var(--color-warning); letter-spacing: -0.025em; }
        .brand-subtitle { font-size: 0.65rem; font-weight: 700; text-align: center; margin-bottom: 2rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.1em; opacity: 0.7; }
        
        .nav-btn {
            display: flex; align-items: center; width: 100%; text-align: left; padding: 0.8rem 1rem;
            border-radius: 0.75rem; color: var(--text-muted); font-weight: 600; transition: all 0.2s;
            margin-bottom: 0.5rem; gap: 0.75rem;
        }
        .nav-btn:hover { background-color: #334155; color: white; }
        .nav-btn.active { background-color: var(--color-accent); color: white; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }

        #content-area { flex-grow: 1; padding: 2.5rem; overflow-y: auto; position: relative; display: flex; flex-direction: column; }
        .app-content { display: none; max-width: 1000px; margin: 0 auto; width: 100%; animation: fadeIn 0.3s ease; flex-grow: 1; }
        .app-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- UI Components --- */
        .app-card { background-color: var(--panel-color); border-radius: 1.25rem; padding: 2rem; border: 1px solid #334155; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.3); }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-muted); font-size: 0.875rem; }
        .form-input {
            width: 100%; padding: 0.75rem 1rem; background-color: #0f172a; border: 1px solid #475569;
            border-radius: 0.75rem; color: white; font-size: 1rem; transition: all 0.2s;
            font-family: var(--font-stack);
        }
        .form-input:disabled { opacity: 0.5; cursor: not-allowed; background-color: #1e293b; }
        .form-input:focus { outline: none; border-color: var(--color-accent); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
        
        /* ä¿®å¤æ—¶é—´é€‰æ‹©å™¨å›¾æ ‡åœ¨æ·±è‰²èƒŒæ™¯ä¸‹ä¸å¯è§çš„é—®é¢˜ */
        input[type="time"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
            opacity: 0.8;
        }

        /* --- Tags Management --- */
        .tag-container { 
            min-height: 120px; max-height: 280px; overflow-y: auto; 
            display: flex; flex-wrap: wrap; align-content: flex-start; gap: 0.6rem; 
            padding: 1.25rem; border: 2px dashed #334155; border-radius: 0.75rem; 
            background: rgba(15, 23, 42, 0.4);
        }
        .tag {
            display: inline-flex; align-items: center; padding: 0.45rem 0.9rem; 
            border-radius: 0.6rem; font-size: 0.95rem; font-weight: 700; color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1);
            animation: tagPop 0.2s ease-out;
        }
        @keyframes tagPop { from { transform: scale(0.85); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .tag:nth-child(4n+1) { background-color: #3b82f6; }
        .tag:nth-child(4n+2) { background-color: #8b5cf6; }
        .tag:nth-child(4n+3) { background-color: #10b981; }
        .tag:nth-child(4n+4) { background-color: #6366f1; }
        
        .tag .remove { margin-left: 0.6rem; cursor: pointer; opacity: 0.6; font-size: 1.1rem; transition: opacity 0.2s; }
        .tag .remove:hover { opacity: 1; }

        .btn { padding: 0.75rem 1.5rem; border-radius: 0.75rem; font-weight: 700; transition: all 0.2s; cursor: pointer; border: none; display: inline-flex; align-items: center; justify-content: center; font-family: var(--font-stack); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: var(--color-accent); color: white; }
        .btn-primary:hover:not(:disabled) { transform: translateY(-1px); filter: brightness(1.1); }
        .btn-warning { background: var(--color-warning); color: #000; }
        .btn-warning:hover:not(:disabled) { transform: translateY(-1px); filter: brightness(1.1); }

        /* --- Clock & Timer --- */
        .big-timer { font-size: 7.5rem; font-weight: 800; font-family: var(--font-mono); color: white; letter-spacing: -2px; line-height: 1; }
        .big-timer.critical { color: var(--color-danger); animation: pulse 1s infinite; }
        .big-timer.waiting { color: var(--color-warning); font-size: 5rem; } 
        @keyframes pulse { 50% { opacity: 0.5; } }

        .clock-face { fill: #1e293b; stroke: #334155; stroke-width: 6; }
        .tick-major { stroke: #f8fafc; stroke-width: 3; }
        .tick-minor { stroke: #475569; stroke-width: 1.5; }
        .clock-num { fill: #94a3b8; font-size: 14px; font-weight: 700; font-family: var(--font-stack); }
        .h-hour { stroke: #ffffff; stroke-width: 6; stroke-linecap: round; }
        .h-min { stroke: #cbd5e1; stroke-width: 4; stroke-linecap: round; }
        .h-sec { stroke: var(--color-danger); stroke-width: 2; stroke-linecap: round; }
        .h-cap { fill: var(--color-danger); }

        #sidebar-toggle { position: absolute; top: 1.5rem; left: 1rem; z-index: 100; color: white; background: var(--panel-color); width: 40px; height: 40px; border-radius: 50%; border: 1px solid #334155; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.2); }

        .mode-selector { display: flex; background: #0f172a; padding: 4px; border-radius: 0.75rem; margin-bottom: 1.5rem; border: 1px solid #334155; }
        .mode-btn { flex: 1; padding: 0.6rem; text-align: center; border-radius: 0.6rem; cursor: pointer; font-weight: 700; font-size: 0.9rem; transition: all 0.2s; color: var(--text-muted); }
        .mode-btn.active { background: #334155; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

        /* Winner Card Animation */
        .chosen-card { animation: winnerGlow 1.5s infinite alternate; }
        @keyframes winnerGlow { from { box-shadow: 0 0 20px rgba(59, 130, 246, 0.5); } to { box-shadow: 0 0 40px rgba(59, 130, 246, 0.8), 0 0 60px rgba(59, 130, 246, 0.4); } }

        /* --- Grouping Results Styles --- */
        .name-reveal { opacity: 0; transform: translateY(10px); transition: all 0.5s ease; }
        .name-reveal.visible { opacity: 1; transform: translateY(0); }
        
        .group-card-colors { --color-bg: #e0e7ff; --color-text: #3730a3; --color-header-bg: #4f46e5; --color-header-text: #ffffff; }
        .group-color-1 { --color-bg: #dbeafe; --color-text: #1e40af; --color-header-bg: #2563eb; }
        .group-color-2 { --color-bg: #d1fae5; --color-text: #065f46; --color-header-bg: #10b981; }
        .group-color-3 { --color-bg: #fef3c7; --color-text: #92400e; --color-header-bg: #f59e0b; }
        .group-color-4 { --color-bg: #fee2e2; --color-text: #991b1b; --color-header-bg: #ef4444; }
        .group-color-5 { --color-bg: #f3e8ff; --color-text: #581c87; --color-header-bg: #9333ea; }
        .group-color-6 { --color-bg: #ffe4e6; --color-text: #9f1239; --color-header-bg: #e11d48; }
        .group-color-7 { --color-bg: #e0f2fe; --color-text: #075985; --color-header-bg: #0ea5e9; }
        .group-color-8 { --color-bg: #dcfce7; --color-text: #166534; --color-header-bg: #22c55e; }
    </style>
</head>
<body>

    <button id="sidebar-toggle">â˜°</button>

    <div id="sidebar">
        <div>
            <h1 class="brand-title">æ•™å¸ˆå·¥å…·ç®±</h1>
            <p class="brand-subtitle">Developed by ç¬¦è€å¸ˆ</p>
        </div>
        <nav>
            <button id="nav-lucky-draw" class="nav-btn active"><span>âœ¨</span> å¹¸è¿æŠ½å¥–</button>
            <button id="nav-grouping" class="nav-btn"><span>ğŸ‰</span> éšæœºåˆ†ç»„</button>
            <button id="nav-exam-timer" class="nav-btn"><span>â±ï¸</span> è€ƒè¯•å€’æ•°</button>
        </nav>
        
        <div class="mt-auto pt-6 border-t border-slate-700 text-center">
            <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mb-1">Developed By</p>
            <p class="text-sm text-slate-300 font-black">ç¬¦è€å¸ˆ</p>
        </div>
    </div>

    <div id="content-area">
        <!-- App: Lucky Draw -->
        <div id="app-lucky-draw" class="app-content active">
            <div id="ld-home-view" class="app-card">
                <div class="text-center mb-6">
                    <h2 class="text-3xl font-extrabold text-white mb-2">âœ¨ å¹¸è¿æŠ½å¥–</h2>
                    <p class="text-muted">ç²˜è´´åå•æˆ–ç›´æ¥è¾“å…¥å§“åï¼ˆå›è½¦æˆ–ç²˜è´´å³è‡ªåŠ¨ç”Ÿæˆæ ‡ç­¾ï¼‰</p>
                </div>
                
                <div id="ld-tag-container" class="tag-container mb-4"></div>
                <input type="text" id="ld-name-input" class="form-input mb-4" placeholder="åœ¨æ­¤ç²˜è´´åå•æˆ–è¾“å…¥å§“å...">
                
                <div class="flex justify-between items-center">
                    <button id="ld-clear-btn" class="btn bg-red-500 hover:bg-red-400 text-black font-bold shadow-md transition-all">æ¸…ç©ºåå•</button>
                    <button id="ld-pick-btn" class="btn btn-warning px-14 text-lg shadow-lg">å¼€å§‹æŠ½å¥–</button>
                </div>
            </div>

            <div id="ld-result-view" class="app-card hidden flex-col items-center">
                <h3 id="ld-result-status" class="text-xl font-bold text-blue-400 mb-8 uppercase tracking-widest">æŠ½å¥–è¿›è¡Œä¸­...</h3>
                <div id="ld-result-card" class="w-full py-20 bg-blue-600 rounded-2xl text-6xl font-black shadow-2xl border-4 border-blue-400 text-white text-center transition-all duration-300">
                    <span id="ld-chosen-name">Ready?</span>
                </div>
                <button id="ld-go-back-btn" class="mt-10 btn border border-slate-600 px-10 bg-slate-800 text-white font-bold hidden">â† è¿”å›ç¼–è¾‘åˆ—è¡¨</button>
            </div>
        </div>

        <!-- App: Grouping -->
        <div id="app-grouping" class="app-content">
            <div id="gp-setup-page" class="app-card">
                <h2 class="text-2xl font-bold mb-6 text-center text-white">ğŸ‰ éšæœºåˆ†ç»„</h2>
                <div id="gp-name-display" class="tag-container mb-4"></div>
                <input type="text" id="gp-name-input" class="form-input mb-6" placeholder="åœ¨æ­¤ç²˜è´´åå•æˆ–è¾“å…¥å§“å...">
                
                <div class="mode-selector">
                    <div class="mode-btn active" data-mode="count">æŒ‰ç»„æ•°åˆ†</div>
                    <div class="mode-btn" data-mode="size">æŒ‰æ¯ç»„äººæ•°åˆ†</div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <!-- Updated Number Stepper UI -->
                    <div class="p-4 bg-slate-800/50 border border-slate-700 rounded-xl flex flex-col items-center justify-center">
                        <label id="gp-label" class="form-label text-center mb-3">éœ€è¦åˆ†å¤šå°‘ç»„ï¼Ÿ</label>
                        <div class="flex items-center gap-3">
                            <button id="gp-btn-minus" class="w-12 h-12 rounded-xl bg-slate-700 hover:bg-slate-600 active:scale-95 text-white font-bold text-2xl transition-all border border-slate-600 shadow-md flex items-center justify-center leading-none pb-1">
                                -
                            </button>
                            <input type="number" id="gp-value" value="2" min="1" class="w-20 bg-transparent text-center text-4xl font-black text-white border-none focus:ring-0 p-0 appearance-none" style="-moz-appearance: textfield;">
                            <button id="gp-btn-plus" class="w-12 h-12 rounded-xl bg-slate-700 hover:bg-slate-600 active:scale-95 text-white font-bold text-2xl transition-all border border-slate-600 shadow-md flex items-center justify-center leading-none pb-1">
                                +
                            </button>
                        </div>
                    </div>
                    <button id="gp-start-btn" class="btn btn-primary text-xl shadow-lg">æ‰§è¡Œéšæœºåˆ†ç»„</button>
                </div>

                <div class="flex justify-start">
                    <button id="gp-clear-btn" class="btn bg-red-500 hover:bg-red-400 text-black font-bold shadow-md transition-all">æ¸…ç©ºåå•</button>
                </div>
            </div>
            
            <div id="gp-results-page" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <button id="gp-back-btn" class="btn border border-slate-600 bg-slate-800 text-white text-sm">â† è¿”å›è®¾ç½®</button>
                    <button id="gp-download-btn" class="btn bg-green-600 hover:bg-green-500 text-white text-sm">ğŸ“¥ ä¸‹è½½åˆ†ç»„ç»“æœ</button>
                </div>
                <div id="gp-results-container" class="flex flex-wrap justify-center gap-6 pb-10"></div>
            </div>
        </div>

        <!-- App: Exam Timer -->
        <div id="app-exam-timer" class="app-content">
            <div id="exam-setup-screen" class="app-card max-w-lg mx-auto">
                <h2 class="text-2xl font-bold mb-6 text-center text-white">â±ï¸ è€ƒè¯•å€’æ•°è®¾ç½®</h2>
                <div class="space-y-5">
                    <div>
                        <label class="form-label">è€ƒè¯•ç§‘ç›® / æ ‡é¢˜</label>
                        <input type="text" id="exam-title-input" class="form-input" placeholder="ä¾‹å¦‚ï¼šåæ–‡æµ‹éªŒ">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="form-label">å¼€å§‹æ—¶é—´</label>
                            <input type="time" id="exam-start-input" class="form-input">
                        </div>
                        <div>
                            <label class="form-label">è€ƒè¯•æ—¶é•¿ (åˆ†é’Ÿ)</label>
                            <input type="number" id="exam-duration-input" class="form-input" value="60">
                        </div>
                    </div>
                    
                    <!-- Dual Buttons Layout -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
                        <button id="exam-set-btn" class="btn bg-slate-700 hover:bg-slate-600 text-slate-200 font-bold py-4 border border-slate-600 shadow-sm">
                            æŒ‰è®¾å®šæ—¶é—´å¼€å§‹
                        </button>
                        <button id="exam-start-now-btn" class="btn btn-primary text-xl font-bold py-4 shadow-xl">
                            ğŸš€ é©¬ä¸Šå¼€å§‹
                        </button>
                    </div>
                </div>
            </div>

            <div id="exam-dashboard-screen" class="hidden space-y-6">
                <div class="app-card flex justify-between items-center bg-slate-800/80 border-blue-500/30 py-4">
                    <h2 id="exam-display-title" class="text-2xl font-black text-blue-400 px-2">--</h2>
                    <div class="text-right px-2">
                        <div id="exam-status-label" class="text-xs text-muted font-bold uppercase tracking-widest">é¢„è®¡ç»“æŸæ—¶é—´</div>
                        <div id="exam-end-time-display" class="text-2xl font-mono text-white font-bold">00:00:00</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="app-card flex flex-col items-center justify-center bg-slate-900/40">
                        <!-- SVG Clock Container -->
                        <div id="clock-container"></div> 
                        <div class="mt-6 flex flex-col items-center">
                            <span class="text-xs text-muted font-bold tracking-widest uppercase mb-1">ç³»ç»Ÿå½“å‰æ—¶é—´</span>
                            <div id="exam-sys-time" class="text-3xl font-mono text-blue-400 bg-slate-950 px-6 py-2 rounded-xl border border-slate-700 shadow-inner">00:00:00</div>
                        </div>
                    </div>
                    <div class="app-card flex flex-col items-center justify-center text-center bg-slate-800/40">
                        <p id="exam-timer-label" class="text-muted uppercase tracking-widest text-sm font-bold mb-4">è€ƒè¯•å‰©ä½™æ—¶é—´</p>
                        <div id="exam-big-timer" class="big-timer">00:00</div>
                        <div class="flex gap-4 mt-12 w-full max-w-xs">
                            <button id="exam-pause-btn" class="btn bg-slate-700 hover:bg-slate-600 flex-1 text-lg">æš‚åœ</button>
                            <button id="exam-reset-btn" class="btn bg-red-900/40 text-red-400 border border-red-500/30 hover:bg-red-900/60 flex-1 text-lg">é‡ç½®è®¾ç½®</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer Attribution with Auto-Year -->
        <footer class="mt-auto pt-10 pb-4 text-center">
            <p class="text-slate-600 text-xs font-medium tracking-widest uppercase">
                &copy; <span id="footer-year"></span> æ•™å¸ˆå·¥å…·ç®± | Developed by ç¬¦è€å¸ˆ
            </p>
        </footer>
    </div>

    <script>
        const $ = (s, r = document) => r.querySelector(s);
        const $$ = (s, r = document) => r.querySelectorAll(s);

        // Set dynamic year in footer
        $('#footer-year').textContent = new Date().getFullYear();

        // --- Core Helpers ---
        function runConfetti() {
            if (typeof confetti === 'undefined') return;
            confetti({ particleCount: 150, spread: 90, origin: { y: 0.6 } });
            confetti({ particleCount: 50, angle: 60, spread: 55, origin: { x: 0 } });
            confetti({ particleCount: 50, angle: 120, spread: 55, origin: { x: 1 } });
        }

        // --- Name System Manager (With Duplicate Check) ---
        function createNameManager(inputId, containerId, pickBtnId = null) {
            const list = [];
            const input = $(inputId);
            const container = $(containerId);
            const pickBtn = pickBtnId ? $(pickBtnId) : null;

            const render = () => {
                container.innerHTML = list.length ? '' : '<span class="text-slate-500 italic flex items-center h-full w-full justify-center opacity-60">åå•ä¸ºç©ºï¼Œè¯·ç²˜è´´æˆ–è¾“å…¥å§“å...</span>';
                list.forEach((name, i) => {
                    const tag = document.createElement('span');
                    tag.className = 'tag';
                    tag.innerHTML = `${name}<span class="remove" data-idx="${i}">Ã—</span>`;
                    container.appendChild(tag);
                });
                if (pickBtn) pickBtn.disabled = list.length === 0;
                container.scrollTop = container.scrollHeight;
            };

            const process = (text) => {
                const rawNames = text.split(/[,\s\n\tï¼Œã€ï¼›;]+/).filter(n => n.trim() !== "");
                let addedCount = 0;
                
                rawNames.forEach(n => {
                    // Prevent duplicates
                    if (!list.includes(n)) {
                        list.push(n);
                        addedCount++;
                    }
                });
                
                render();
            };

            input.onkeydown = (e) => { if (e.key === 'Enter') { e.preventDefault(); process(input.value); input.value = ''; } };
            input.onpaste = (e) => { e.preventDefault(); process((e.clipboardData || window.clipboardData).getData('text')); input.value = ''; };
            container.onclick = (e) => { if (e.target.classList.contains('remove')) { list.splice(e.target.dataset.idx, 1); render(); } };

            return { list, render, clear: () => { list.length = 0; render(); } };
        }

        // --- Lucky Draw Logic ---
        const ldMgr = createNameManager('#ld-name-input', '#ld-tag-container', '#ld-pick-btn');
        let shuffleInterval = null;

        function showLdView(viewId) {
            if (viewId === 'home') {
                $('#ld-home-view').classList.remove('hidden');
                $('#ld-result-view').classList.add('hidden');
                $('#ld-result-card').classList.remove('chosen-card');
                $('#ld-go-back-btn').classList.add('hidden');
            } else {
                $('#ld-home-view').classList.add('hidden');
                $('#ld-result-view').classList.remove('hidden');
                $('#ld-result-view').classList.add('flex');
            }
        }

        const visualShuffle = (names) => {
            const randomIndex = Math.floor(Math.random() * names.length);
            $('#ld-chosen-name').textContent = names[randomIndex];
        };

        $('#ld-pick-btn').onclick = () => {
            const names = ldMgr.list;
            if (names.length === 0) return;
            showLdView('result');
            let speed = 60;
            shuffleInterval = setInterval(() => visualShuffle(names), speed);
            setTimeout(() => { clearInterval(shuffleInterval); speed = 150; shuffleInterval = setInterval(() => visualShuffle(names), speed); }, 1200);
            setTimeout(() => { clearInterval(shuffleInterval); speed = 400; shuffleInterval = setInterval(() => visualShuffle(names), speed); }, 2200);
            setTimeout(() => {
                clearInterval(shuffleInterval);
                const winner = names[Math.floor(Math.random() * names.length)];
                $('#ld-chosen-name').textContent = winner;
                $('#ld-result-status').textContent = "ğŸ¥³ å¾—å¥–çš„æ˜¯... ğŸ¥³";
                $('#ld-result-card').classList.add('chosen-card');
                runConfetti();
                $('#ld-go-back-btn').classList.remove('hidden');
            }, 3500);
        };
        $('#ld-go-back-btn').onclick = () => showLdView('home');
        $('#ld-clear-btn').onclick = () => { ldMgr.clear(); };

        // --- Grouping Logic ---
        const gpMgr = createNameManager('#gp-name-input', '#gp-name-display', '#gp-start-btn');
        let gpMode = 'count';
        const colorPalette = ['group-color-1', 'group-color-2', 'group-color-3', 'group-color-4', 'group-color-5', 'group-color-6', 'group-color-7', 'group-color-8'];

        $$('.mode-btn').forEach(btn => {
            btn.onclick = () => {
                $$('.mode-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                gpMode = btn.dataset.mode;
                $('#gp-label').textContent = gpMode === 'count' ? 'éœ€è¦åˆ†å¤šå°‘ç»„ï¼Ÿ' : 'æ¯ç»„å¤šå°‘äººï¼Ÿ';
            };
        });

        // New Stepper Logic
        $('#gp-btn-minus').onclick = () => {
            const input = $('#gp-value');
            let val = parseInt(input.value) || 0;
            if (val > 1) input.value = val - 1;
        };

        $('#gp-btn-plus').onclick = () => {
            const input = $('#gp-value');
            let val = parseInt(input.value) || 0;
            input.value = val + 1;
        };

        $('#gp-clear-btn').onclick = () => { gpMgr.clear(); };

        function revealNamesOneByOne() {
            const namesToReveal = document.querySelectorAll('.name-reveal');
            let delay = 0;
            const interval = 200; 
            namesToReveal.forEach((nameEl) => {
                setTimeout(() => { nameEl.classList.add('visible'); }, delay);
                delay += interval;
            });
        }

        function buildResultsCards(groups) {
            const resultsContainer = $('#gp-results-container');
            resultsContainer.innerHTML = '';
            
            groups.forEach((groupNames, index) => {
                const colorClass = colorPalette[index % colorPalette.length];
                const card = document.createElement('div');
                card.className = `group-card-colors ${colorClass} w-full sm:w-64 bg-white rounded-lg shadow-md overflow-hidden flex-shrink-0 mb-4 transform transition-all hover:scale-105`;
                
                const headerStyle = `background-color: var(--color-header-bg); color: var(--color-header-text);`;
                const bodyStyle = `background-color: var(--color-bg); color: var(--color-text);`;

                const header = document.createElement('div');
                header.className = 'p-3 flex justify-between items-center';
                header.setAttribute('style', headerStyle);
                header.innerHTML = `
                    <h3 class="text-lg font-bold">Group ${index + 1}</h3>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 opacity-80" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a2 2 0 00-2-2H6a2 2 0 00-2 2v3h12z" />
                    </svg>`;
                
                const body = document.createElement('ul');
                body.className = 'divide-y divide-gray-200/20'; 
                body.setAttribute('style', bodyStyle);

                if (groupNames.length === 0) {
                    body.innerHTML = '<li class="px-4 py-3 text-sm italic opacity-70">Empty</li>';
                } else {
                    groupNames.forEach((name, i) => {
                        const li = document.createElement('li');
                        li.className = 'name-reveal px-4 py-3 text-sm font-medium flex items-center';
                        if (i % 2 === 1) li.style.backgroundColor = 'rgba(255,255,255,0.2)';
                        li.textContent = name;
                        body.appendChild(li);
                    });
                }
                
                card.appendChild(header);
                card.appendChild(body);
                resultsContainer.appendChild(card);
            });
            revealNamesOneByOne();
        }

        $('#gp-start-btn').onclick = () => {
            const val = parseInt($('#gp-value').value);
            // Minimum check: list needs at least 1 person. 
            // Originally < 2, but for testing "1 person group" logic, < 1 is safer, though grouping usually implies > 1. 
            // Keeping < 2 to be safe for "grouping" context, but if you have 4 people it passes.
            if (!val || val < 1 || gpMgr.list.length < 2) return;

            const shuffled = [...gpMgr.list].sort(() => Math.random() - 0.5);
            let groups = [];

            if (gpMode === 'count') {
                // Mode 1: Split into N groups (Try to be even)
                // "æŒ‰ç»„æ•°åˆ†" - Round Robin distribution
                const groupCount = Math.min(val, shuffled.length);
                groups = Array.from({ length: groupCount }, () => []);
                shuffled.forEach((name, i) => groups[i % groupCount].push(name));
            } else {
                // Mode 2: Split by Size (Fill first group, then second...)
                // "æŒ‰æ¯ç»„äººæ•°åˆ†" - Chunking
                for (let i = 0; i < shuffled.length; i += val) {
                    groups.push(shuffled.slice(i, i + val));
                }
            }
            
            buildResultsCards(groups);
            
            $('#gp-setup-page').classList.add('hidden');
            $('#gp-results-page').classList.remove('hidden');
        };

        $('#gp-back-btn').onclick = () => { $('#gp-setup-page').classList.remove('hidden'); $('#gp-results-page').classList.add('hidden'); };
        
        $('#gp-download-btn').onclick = () => {
            const resultsHTML = $('#gp-results-container').innerHTML;
            const styles = `
                <script src="https://cdn.tailwindcss.com"><\/script>
                <style>
                    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; padding: 20px; }
                    .group-card-colors { --color-bg: #e0e7ff; --color-text: #3730a3; --color-header-bg: #4f46e5; --color-header-text: #ffffff; }
                    .group-color-1 { --color-bg: #dbeafe; --color-text: #1e40af; --color-header-bg: #2563eb; }
                    .group-color-2 { --color-bg: #d1fae5; --color-text: #065f46; --color-header-bg: #10b981; }
                    .group-color-3 { --color-bg: #fef3c7; --color-text: #92400e; --color-header-bg: #f59e0b; }
                    .group-color-4 { --color-bg: #fee2e2; --color-text: #991b1b; --color-header-bg: #ef4444; }
                    .group-color-5 { --color-bg: #f3e8ff; --color-text: #581c87; --color-header-bg: #9333ea; }
                    .group-color-6 { --color-bg: #ffe4e6; --color-text: #9f1239; --color-header-bg: #e11d48; }
                    .group-color-7 { --color-bg: #e0f2fe; --color-text: #075985; --color-header-bg: #0ea5e9; }
                    .group-color-8 { --color-bg: #dcfce7; --color-text: #166534; --color-header-bg: #22c55e; }
                    .name-reveal { opacity: 1 !important; transform: none !important; }
                </style>`;
            
            const htmlContent = `
                <!DOCTYPE html><html lang="en">
                <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>åˆ†ç»„ç»“æœ - æ•™å¸ˆå·¥å…·ç®±</title>${styles}</head>
                <body>
                    <h1 class="text-3xl font-bold text-center mb-8 text-gray-800">åˆ†ç»„ç»“æœ (Generated Groups)</h1>
                    <div class="flex flex-wrap justify-center gap-6">${resultsHTML}</div>
                </body></html>`;
            
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `student-groups-${new Date().toISOString().slice(0,10)}.html`;
            a.click();
            URL.revokeObjectURL(a.href);
        };

        // --- Exam Timer Logic (Fully Synced) ---
        let examStart = null;
        let examEnd = null;
        let isPaused = false;
        let pauseLeft = 0; 
        let pauseLeftWait = 0; 
        let examState = 'idle'; // 'waiting', 'running', 'paused', 'finished'

        // Initialize SVG Clock
        function initClock() {
            const container = $('#clock-container');
            if(container.innerHTML) return;
            
            let t = `<svg id="exam-analog-clock" width="280" height="280" viewBox="0 0 220 220">
                <circle cx="110" cy="110" r="100" class="clock-face"/>`;
            for (let i = 0; i < 60; i++) {
                const a = i * 6 * Math.PI / 180;
                const maj = i % 5 === 0;
                t += `<line x1="${110+98*Math.sin(a)}" y1="${110-98*Math.cos(a)}" x2="${110+(maj?85:92)*Math.sin(a)}" y2="${110-(maj?85:92)*Math.cos(a)}" class="${maj?'tick-major':'tick-minor'}"/>`;
                if (maj) t += `<text x="${110+75*Math.sin(a)}" y="${110-75*Math.cos(a)+5}" class="clock-num" text-anchor="middle">${i===0?12:i/5}</text>`;
            }
            t += `<line id="h-hour" x1="110" y1="110" x2="110" y2="65" class="h-hour"/><line id="h-min" x1="110" y1="110" x2="110" y2="50" class="h-min"/><line id="h-sec" x1="110" y1="110" x2="110" y2="40" class="h-sec"/><circle cx="110" cy="110" r="4" class="h-cap"/></svg>`;
            container.innerHTML = t;
        }

        function formatTime(sec) {
            const h = Math.floor(sec / 3600);
            const m = Math.floor((sec % 3600) / 60);
            const s = sec % 60;
            return `${h>0?h+':':''}${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        }

        // --- Unified High-Frequency Loop ---
        function startUnifiedLoop() {
            initClock();
            const hSec = $('#h-sec');
            const hMin = $('#h-min');
            const hHour = $('#h-hour');
            const sysTime = $('#exam-sys-time');
            const bigTimer = $('#exam-big-timer');

            function step() {
                const now = new Date();
                
                // 1. Update Analog Clock (Tick style)
                const s = now.getSeconds();
                const m = now.getMinutes();
                const h = now.getHours();

                // Discrete ticking seconds
                const sAngle = s * 6;
                const mAngle = m * 6 + s * 0.1;
                const hAngle = (h % 12) * 30 + m * 0.5;

                if(hSec) hSec.setAttribute('transform', `rotate(${sAngle}, 110, 110)`);
                if(hMin) hMin.setAttribute('transform', `rotate(${mAngle}, 110, 110)`);
                if(hHour) hHour.setAttribute('transform', `rotate(${hAngle}, 110, 110)`);
                
                // 2. Update System Digital Time
                if(sysTime) sysTime.textContent = now.toTimeString().split(' ')[0];

                // 3. Update Exam Countdown (Synced)
                if (!isPaused && examEnd) {
                    if (examState === 'waiting') {
                        // Changed Math.floor to Math.ceil for waiting countdown
                        const diff = Math.ceil((examStart - now) / 1000);
                        if (diff <= 0) {
                            // Start Time Reached
                            examState = 'running';
                            $('#exam-timer-label').textContent = "è€ƒè¯•å‰©ä½™æ—¶é—´";
                            $('#exam-status-label').textContent = "é¢„è®¡ç»“æŸæ—¶é—´";
                            $('#exam-big-timer').classList.remove('waiting');
                            $('#exam-end-time-display').textContent = examEnd.toTimeString().split(' ')[0];
                        } else {
                            if(bigTimer) bigTimer.textContent = formatTime(diff);
                        }
                    } else if (examState === 'running') {
                        // Changed Math.floor to Math.ceil for exam countdown
                        const diff = Math.max(0, Math.ceil((examEnd - now) / 1000));
                        if(bigTimer) bigTimer.textContent = formatTime(diff);
                        
                        if (diff < 60) $('#exam-big-timer').classList.add('critical');
                        else $('#exam-big-timer').classList.remove('critical');
                        
                        if (diff === 0) { 
                            examState = 'finished';
                            alert("è€ƒè¯•æ—¶é—´åˆ°ï¼");
                        }
                    }
                }

                requestAnimationFrame(step);
            }
            requestAnimationFrame(step);
        }

        function startExam(isImmediate) {
            const dur = parseInt($('#exam-duration-input').value);
            const title = $('#exam-title-input').value || "è€ƒè¯•å€’è®¡æ—¶";
            
            let startTime = new Date();
            let isFutureStart = false;

            if (!isImmediate && $('#exam-start-input').value) {
                const [h, m] = $('#exam-start-input').value.split(':');
                const tempStart = new Date();
                tempStart.setHours(h, m, 0, 0);
                
                if (tempStart > new Date(Date.now() + 5000)) {
                    startTime = tempStart;
                    isFutureStart = true;
                }
            }

            examStart = startTime;
            examEnd = new Date(startTime.getTime() + dur * 60000);
            
            $('#exam-display-title').textContent = title;
            $('#exam-setup-screen').classList.add('hidden');
            $('#exam-dashboard-screen').classList.remove('hidden');
            
            isPaused = false;
            
            if (isFutureStart) {
                examState = 'waiting';
                $('#exam-timer-label').textContent = "è·ç¦»è€ƒè¯•å¼€å§‹";
                $('#exam-status-label').textContent = "è®¡åˆ’å¼€å§‹æ—¶é—´";
                $('#exam-end-time-display').textContent = examStart.toTimeString().split(' ')[0];
                $('#exam-big-timer').classList.add('waiting');
            } else {
                examState = 'running';
                $('#exam-timer-label').textContent = "è€ƒè¯•å‰©ä½™æ—¶é—´";
                $('#exam-status-label').textContent = "é¢„è®¡ç»“æŸæ—¶é—´";
                $('#exam-end-time-display').textContent = examEnd.toTimeString().split(' ')[0];
                $('#exam-big-timer').classList.remove('waiting');
            }
        }

        $('#exam-set-btn').onclick = () => startExam(false);
        $('#exam-start-now-btn').onclick = () => startExam(true);

        $('#exam-pause-btn').onclick = () => {
            if (!examEnd) return;
            isPaused = !isPaused;
            const now = new Date();

            if (isPaused) {
                if (examState === 'waiting') {
                    pauseLeftWait = examStart - now; 
                    pauseLeft = examEnd - examStart; 
                } else if (examState === 'running') {
                    pauseLeft = examEnd - now;
                }
                
                $('#exam-pause-btn').textContent = "ç»§ç»­";
                $('#exam-pause-btn').classList.add('bg-blue-600');
            } else {
                if (examState === 'waiting') {
                    examStart = new Date(now.getTime() + pauseLeftWait);
                    examEnd = new Date(examStart.getTime() + pauseLeft);
                    $('#exam-end-time-display').textContent = examStart.toTimeString().split(' ')[0];
                } else if (examState === 'running') {
                    examEnd = new Date(now.getTime() + pauseLeft);
                    $('#exam-end-time-display').textContent = examEnd.toTimeString().split(' ')[0];
                }

                $('#exam-pause-btn').textContent = "æš‚åœ";
                $('#exam-pause-btn').classList.remove('bg-blue-600');
            }
        };

        $('#exam-reset-btn').onclick = () => {
            examEnd = null;
            examStart = null;
            isPaused = false;
            examState = 'idle';
            
            $('#exam-setup-screen').classList.remove('hidden');
            $('#exam-dashboard-screen').classList.add('hidden');
            $('#exam-big-timer').textContent = "00:00";
            $('#exam-big-timer').classList.remove('critical');
            $('#exam-big-timer').classList.remove('waiting');
            $('#exam-pause-btn').textContent = "æš‚åœ";
            $('#exam-pause-btn').classList.remove('bg-blue-600');
        };

        // --- Navigation ---
        $$('.nav-btn').forEach(btn => {
            btn.onclick = () => {
                $$('.nav-btn').forEach(b => b.classList.remove('active'));
                $$('.app-content').forEach(a => a.classList.remove('active'));
                btn.classList.add('active');
                $(`#app-${btn.id.split('nav-')[1]}`).classList.add('active');
            };
        });

        $('#sidebar-toggle').onclick = () => document.body.classList.toggle('sidebar-retracted');

        // Initial Start
        const iNow = new Date();
        $('#exam-start-input').value = `${String(iNow.getHours()).padStart(2,'0')}:${String(iNow.getMinutes()).padStart(2,'0')}`;
        startUnifiedLoop(); // Start the loop
    </script>
</body>
</html>
